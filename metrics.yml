---
- name: Metrics RPi
  hosts: rick-prime
  gather_facts: true
  vars:
    ansible_user: rsanchez

  tasks:
    - name: Collect Resource Usage for Raspberry Pi
      block:
        - name: Collect CPU usage
          ansible.builtin.shell: "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
          register: cpu_usage

        - name: Collect memory usage
          ansible.builtin.shell: "free | grep Mem | awk '{print $3/$2 * 100.0}'"
          register: mem_usage

        - name: Collect disk usage
          ansible.builtin.shell: "df -h / | grep / | awk '{ print $5 }' | sed 's/%//g'"
          register: disk_usage

    - name: Save metrics to Variable
      ansible.builtin.debug:
        msg: |
          {
            "cpu_usage": "{{ cpu_usage.stdout }}",
            "mem_usage": "{{ mem_usage.stdout }}",
            "disk_usage": "{{ disk_usage.stdout }}"
          }
      register: metrics

- name: Execute Robot Framework Test in Remote environment
  hosts: manila-john
  gather_facts: false
  vars:
    ansible_user: ewilson

  tasks:
    - name: Copy Robot Framework Test to Remote Host
      ansible.builtin.copy:
        src: /media/ewilson/Repositories/ansible/rpi_resources.robot
        dest: /tmp/rpi_resources.robot
        remote_src: false
        mode: '0744'
      
    - name: Save metrics to File
      ansible.builtin.copy:
        content: "{{ metrics }}"
        dest: /tmp/metrics.json
        mode: '0744'

    - name: Copy Robot Framework Test to Remote Host
      ansible.builtin.copy:
        src: /media/ewilson/Repositories/ansible/rpi_resources.robot
        dest: /tmp/rpi_resources.robot
        remote_src: false
        mode: '0744'

    - name: Execute Robot Framework Test
      ansible.builtin.shell: "robot -d /tmp/robot_results /tmp/rpi_resources.robot"
      args:
        chdir: /tmp
      register: robot_output
      delegate_to: manila-john

    - name: Display Robot Framework Result
      ansible.builtin.debug:
        var: robot_output.stdout_lines

    - name: Execute Robot Framework Test
      ansible.builtin.shell: "robot -d /tmp/robot_results /tmp/rpi_resources.robot"
      args:
        chdir: /tmp
      register: robot_output
      delegate_to: localhost

    - name: Display Robot Framework Result
      ansible.builtin.debug:
        var: robot_output.stdout_lines